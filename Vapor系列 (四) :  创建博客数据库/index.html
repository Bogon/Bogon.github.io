<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="G0fHOrfJn5sHWzmi6ZCcg2aX83myBc-9U1BJZJJDSTU">
  <meta name="baidu-site-verification" content="7gJOLignE2">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.xuebaonline.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Vapor系列 (四) :  创建博客数据库">
<meta property="og:type" content="article">
<meta property="og:title" content="Vapor系列 (四) :  创建博客数据库">
<meta property="og:url" content="https://www.xuebaonline.com/Vapor%E7%B3%BB%E5%88%97%20(%E5%9B%9B)%20:%20%20%E5%88%9B%E5%BB%BA%E5%8D%9A%E5%AE%A2%E6%95%B0%E6%8D%AE%E5%BA%93/index.html">
<meta property="og:site_name" content="Char&#39;s Blog">
<meta property="og:description" content="Vapor系列 (四) :  创建博客数据库">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.xuebaonline.com/vapor-4-stp2.png">
<meta property="og:image" content="https://cdn.xuebaonline.com/vapor-4-stp1.png">
<meta property="article:published_time" content="2020-06-22T04:14:10.000Z">
<meta property="article:modified_time" content="2020-06-22T13:01:43.310Z">
<meta property="article:author" content="Char">
<meta property="article:tag" content="iOS">
<meta property="article:tag" content="Swift">
<meta property="article:tag" content="Swift Vapor">
<meta property="article:tag" content="Swift学习">
<meta property="article:tag" content="Swift进阶">
<meta property="article:tag" content="Protocols">
<meta property="article:tag" content="协议编程">
<meta property="article:tag" content="泛型">
<meta property="article:tag" content="编程">
<meta property="article:tag" content="多态">
<meta property="article:tag" content="Collection Types">
<meta property="article:tag" content="Arrays">
<meta property="article:tag" content="Dictionaries">
<meta property="article:tag" content="Sets">
<meta property="article:tag" content="使用闭包集合迭代">
<meta property="article:tag" content="Strings">
<meta property="article:tag" content="构建自己的类型">
<meta property="article:tag" content="Structures">
<meta property="article:tag" content="结构体">
<meta property="article:tag" content="Methods">
<meta property="article:tag" content="Classes">
<meta property="article:tag" content="Enumerations">
<meta property="article:tag" content="Protocols">
<meta property="article:tag" content="Generics">
<meta property="article:tag" content="访问控制和代码组织">
<meta property="article:tag" content="自定义运算符，下标和键路径">
<meta property="article:tag" content="模式匹配">
<meta property="article:tag" content="错误处理">
<meta property="article:tag" content="Encoding 和 Decoding Types">
<meta property="article:tag" content="内存管理">
<meta property="article:tag" content="值类型和值语义">
<meta property="article:tag" content="面向协议编程(OOP)">
<meta property="article:tag" content="高级协议和泛型">
<meta property="article:tag" content="Vapor4.0">
<meta property="article:tag" content="Hello Vapor">
<meta property="article:tag" content="Leaf">
<meta property="article:tag" content="创建博客数据库">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.xuebaonline.com/vapor-4-stp2.png">

<link rel="canonical" href="https://www.xuebaonline.com/Vapor%E7%B3%BB%E5%88%97%20(%E5%9B%9B)%20:%20%20%E5%88%9B%E5%BB%BA%E5%8D%9A%E5%AE%A2%E6%95%B0%E6%8D%AE%E5%BA%93/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Vapor系列 (四) :  创建博客数据库 | Char's Blog</title>
  
    <script>
      function sendPageView() {
        if (CONFIG.hostname !== location.hostname) return;
        var uid = localStorage.getItem('uid') || (Math.random() + '.' + Math.random());
        localStorage.setItem('uid', uid);
        navigator.sendBeacon('https://www.google-analytics.com/collect', new URLSearchParams({
          v  : 1,
          tid: 'UA-165583776-1',
          cid: uid,
          t  : 'pageview',
          dp : encodeURIComponent(location.pathname)
        }));
      }
      document.addEventListener('pjax:complete', sendPageView);
      sendPageView();
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f44aa1d26d8ba6a20c1a09a9cdcd7e3d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Char's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Char's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">如切如磋，如琢如磨。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">124</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">51</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">151</span></a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.xuebaonline.com/Vapor%E7%B3%BB%E5%88%97%20(%E5%9B%9B)%20:%20%20%E5%88%9B%E5%BB%BA%E5%8D%9A%E5%AE%A2%E6%95%B0%E6%8D%AE%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.xuebaonline.com/blog_avatar.JPG">
      <meta itemprop="name" content="Char">
      <meta itemprop="description" content="曾经沧海难为水，除却巫山不是云。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Char's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Vapor系列 (四) :  创建博客数据库
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-22 12:14:10" itemprop="dateCreated datePublished" datetime="2020-06-22T12:14:10+08:00">2020-06-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Vapor-4-0/" itemprop="url" rel="index"><span itemprop="name">Vapor 4.0</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/Vapor%E7%B3%BB%E5%88%97%20(%E5%9B%9B)%20:%20%20%E5%88%9B%E5%BB%BA%E5%8D%9A%E5%AE%A2%E6%95%B0%E6%8D%AE%E5%BA%93/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Vapor%E7%B3%BB%E5%88%97%20(%E5%9B%9B)%20:%20%20%E5%88%9B%E5%BB%BA%E5%8D%9A%E5%AE%A2%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>16 分钟</span>
            </span>
            <div class="post-description">Vapor系列 (四) :  创建博客数据库</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>您将了解Fluent ORM框架以及使用此类工具而不是编写原始数据库查询的优势。 我们将设置由SQLite驱动程序支持的Fluent，并使用Swift中的属性包装器对数据库字段进行建模。 我们将为数据库提供种子，熟悉迁移脚本并在网站上进行一些更改，以便它可以查询本地数据库中的博客文章并使用Leaf呈现它们。</p>
<h1 id="从Fluent入手"><a href="#从Fluent入手" class="headerlink" title="从Fluent入手"></a>从Fluent入手</h1><p>首先，我们必须添加Fluent作为依赖项。 Fluent是数据库引擎之上的抽象层。 主要实现分为独立的Swift包。 Fluent附带了几个数据库驱动程序，每个数据库驱动程序都有自己的SPM存储库。 在此示例中，我们将使用SQLite驱动程序。</p>
<p>让我们将新的依赖项添加到Package.swift文件中：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Package.swift */</span></span><br><span class="line"><span class="comment">// swift-tools-version:5.2</span></span><br><span class="line"><span class="keyword">import</span> PackageDescription</span><br><span class="line"><span class="keyword">let</span> package = <span class="type">Package</span>( name: <span class="string">"myProject"</span>, </span><br><span class="line">    platforms: [</span><br><span class="line">    .macOS(.v10_15) ],</span><br><span class="line">    dependencies: [</span><br><span class="line">        <span class="comment">// 💧 A server-side Swift web framework.</span></span><br><span class="line">        .package(url: <span class="string">"https://github.com/vapor/vapor.git"</span>, from: <span class="string">"4.5.0"</span>), </span><br><span class="line">        .package(url: <span class="string">"https://github.com/vapor/leaf.git"</span>, from: <span class="string">"4.0.0-rc.1"</span>), </span><br><span class="line">        .package(url: <span class="string">"https://github.com/vapor/fluent.git"</span>, from: <span class="string">"4.0.0-rc"</span>), </span><br><span class="line">        .package(url: <span class="string">"https://github.com/vapor/fluent-sqlite-driver.git"</span>, from:  <span class="string">"4.0.0-rc"</span>) ],</span><br><span class="line">    targets: [</span><br><span class="line">        .target(name: <span class="string">"App"</span>, dependencies: [</span><br><span class="line">        .product(name: <span class="string">"Leaf"</span>, package: <span class="string">"leaf"</span>),</span><br><span class="line">        .product(name: <span class="string">"Fluent"</span>, package: <span class="string">"fluent"</span>),</span><br><span class="line">        .product(name: <span class="string">"FluentSQLiteDriver"</span>, package: <span class="string">"fluent-sqlite-driver"</span>), .product(name: <span class="string">"Vapor"</span>, package: <span class="string">"vapor"</span>),</span><br><span class="line">    ]),</span><br><span class="line">    .target(name: <span class="string">"Run"</span>, dependencies: [<span class="string">"App"</span>]), .testTarget(name: <span class="string">"AppTests"</span>, dependencies: [</span><br><span class="line">        .target(name: <span class="string">"App"</span>),</span><br><span class="line">        .product(name: <span class="string">"XCTVapor"</span>, package: <span class="string">"vapor"</span>), ])</span><br><span class="line">    ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<p>一旦更新了软件包或Xcode已准备好进行解析过程，就可以通过导入框架开始使用Fluent。 Fluent软件包包含Vapor的扩展，FluentKit是实际的抽象层，而Fluent[db]Driver是给定数据库驱动程序的实现。 您不必显式导入FluentKit。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Sources/App/configure.swift */</span></span><br><span class="line"><span class="keyword">import</span> Leaf</span><br><span class="line"><span class="keyword">import</span> Fluent</span><br><span class="line"><span class="keyword">import</span> FluentSQLiteDriver </span><br><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">configure</span><span class="params">(<span class="number">_</span> app: Application)</span></span> <span class="keyword">throws</span> &#123;</span><br><span class="line">    app.databases.use(.sqlite(.file(<span class="string">"db.sqlite"</span>)), <span class="keyword">as</span>: .sqlite)</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在配置文件中，您必须同时导入Fluent和FluentSQLiteDriver程序包，但这是唯一必须导入特定驱动程序实现的地方。 SQLite数据库可以将数据保存到内存或文件存储中，我们将对其进行配置，以将所有内容持久保存到db.sqlite文件中。</p>
<p>好消息是，这是您唯一需要与基础驱动程序进行交互的文件。 从现在开始，您只需要在其他任何地方导入抽象Fluent模块，就可以通过ORM框架使用数据库了。 如果要切换到新的数据库驱动程序，只需更改配置即可。 我们将在下一章中进行。</p>
<h1 id="使用模型"><a href="#使用模型" class="headerlink" title="使用模型"></a>使用模型</h1><p>建模博客数据库的下一步是创建一个实体，该实体将代表博客文章的类别。 模型基本上是数据库中的表行。 使用Fluent框架，编写模型定义是一件容易的事，我们只需要遵循Model协议即可。 BlogCategoryModel.swift文件应放在Models目录下的blog模块中，并且应如下所示：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Sources/App/Modules/Blog/Models/BlogCategoryModel.swift */</span></span><br><span class="line"><span class="keyword">import</span> Vapor </span><br><span class="line"><span class="keyword">import</span> Fluent</span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BlogCategoryModel</span>: <span class="title">Model</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> schema = <span class="string">"blog_categories"</span></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">FieldKeys</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">var</span> title: <span class="type">FieldKey</span> &#123; <span class="string">"title"</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="type">ID</span>() <span class="keyword">var</span> id: <span class="type">UUID?</span></span><br><span class="line"></span><br><span class="line">    @<span class="type">Field</span>(key: <span class="type">FieldKeys</span>.title) </span><br><span class="line">    <span class="keyword">var</span> title: <span class="type">String</span> </span><br><span class="line">    @<span class="type">Children</span>(<span class="keyword">for</span>: \.$category) </span><br><span class="line">    <span class="keyword">var</span> posts: [<span class="type">BlogPostModel</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>() &#123; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(id: <span class="type">UUID?</span> = <span class="literal">nil</span>, title: <span class="type">String</span>) &#123; </span><br><span class="line">        <span class="keyword">self</span>.id = id</span><br><span class="line">        <span class="keyword">self</span>.title = title </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>您需要创建一个架构属性，该属性是将要存储这些实体的数据库表的名称。每行的名称将使用新的FieldKey类型定义。我总是喜欢将所有键作为静态变量的结构。在迁移过程中，您可以使用这些键来创建基础数据库方案。</p>
<p>字段是Swift的属性，使用属性包装器表示查询的标识符和更复杂的映射。这意味着数据库字段标记有来自Fluent框架的特殊属性包装器。 @ID包装器用于创建唯一标识符。 @Field包装器可用于设置常规字段以及相应的键作为数据库列。 @Children和@Parent包装器都用于在关系之间创建链接。每个属性包装器都有一个关联的字段键。</p>
<p>模型应具有唯一的标识符字段。在最新版本的Fluent中，UUID是用于此目的的首选类型，但您也可以使用Int或其他类型，但我不建议这样做。当前，UUID是唯一适用于所有驱动程序的id类型。</p>
<p>作为字段，您可以使用Swift编程语言中的任何类型，可以存储字符串，数字，枚举甚至复杂的JSON对象。您可以在有关Fluent的文章中阅读有关受支持类型的更多信息。 Model实例的最后一步是实现必要的init方法。模型始终被定义为类，您必须手动创建这些init方法，值得寻找一些可以为您生成的Xcode扩展。</p>
<p>基于我们所知道的，BlogPostModel应该看起来像这样：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Sources/App/Modules/Blog/Models/BlogPostModel.swift */</span></span><br><span class="line"><span class="keyword">import</span> Vapor </span><br><span class="line"><span class="keyword">import</span> Fluent</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BlogPostModel</span>: <span class="title">Model</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> schema: <span class="type">String</span> = <span class="string">"blog_posts"</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">FieldKeys</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">var</span> title: <span class="type">FieldKey</span> &#123; <span class="string">"title"</span> &#125;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">var</span> slug: <span class="type">FieldKey</span> &#123; <span class="string">"slug"</span> &#125;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">var</span> image: <span class="type">FieldKey</span> &#123; <span class="string">"image"</span> &#125;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">var</span> excerpt: <span class="type">FieldKey</span> &#123; <span class="string">"excerpt"</span> &#125; </span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">var</span> date: <span class="type">FieldKey</span> &#123; <span class="string">"date"</span> &#125;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">var</span> content: <span class="type">FieldKey</span> &#123; <span class="string">"content"</span> &#125; </span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">var</span> categoryId: <span class="type">FieldKey</span> &#123; <span class="string">"category_id"</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="type">ID</span>() <span class="keyword">var</span> id: <span class="type">UUID?</span></span><br><span class="line">    @<span class="type">Field</span>(key: <span class="type">FieldKeys</span>.title) <span class="keyword">var</span> title: <span class="type">String</span></span><br><span class="line">    @<span class="type">Field</span>(key: <span class="type">FieldKeys</span>.slug) <span class="keyword">var</span> slug: <span class="type">String</span></span><br><span class="line">    @<span class="type">Field</span>(key: <span class="type">FieldKeys</span>.image) <span class="keyword">var</span> image: <span class="type">String</span></span><br><span class="line">    @<span class="type">Field</span>(key: <span class="type">FieldKeys</span>.excerpt) <span class="keyword">var</span> excerpt: <span class="type">String</span></span><br><span class="line">    @<span class="type">Field</span>(key: <span class="type">FieldKeys</span>.date) <span class="keyword">var</span> date: <span class="type">Date</span></span><br><span class="line">    @<span class="type">Field</span>(key: <span class="type">FieldKeys</span>.content) <span class="keyword">var</span> content: <span class="type">String</span></span><br><span class="line">    @<span class="type">Parent</span>(key: <span class="type">FieldKeys</span>.categoryId) <span class="keyword">var</span> category: <span class="type">BlogCategoryModel</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>() &#123; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(id: <span class="type">UUID?</span> = <span class="literal">nil</span>, title: <span class="type">String</span>, slug: <span class="type">String</span>, image: <span class="type">String</span>, excerpt: <span class="type">String</span>, date: <span class="type">Date</span>, content: <span class="type">String</span>, categoryId: <span class="type">UUID</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">self</span>.id = id</span><br><span class="line">        <span class="keyword">self</span>.title = title</span><br><span class="line">        <span class="keyword">self</span>.slug = slug</span><br><span class="line">        <span class="keyword">self</span>.image = image </span><br><span class="line">        <span class="keyword">self</span>.excerpt = excerpt </span><br><span class="line">        <span class="keyword">self</span>.date = date</span><br><span class="line">        <span class="keyword">self</span>.content = content </span><br><span class="line">        <span class="keyword">self</span>.$category.id = categoryId</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>几乎相同的模式，只是我们将类别标记为@Parent，因为我们希望能够在类别下放置多个帖子，所以这是一对多关系，其中帖子用@Children标记 包装器使用另一个对象的关键路径。 稍后，我们将更多地讨论关系和关键路径，但现在就可以使用了。 在开始使用这些模型之前，我们必须创建一些迁移。</p>
<h1 id="数据库迁移"><a href="#数据库迁移" class="headerlink" title="数据库迁移"></a>数据库迁移</h1><p>迁移是创建，更新或删除一个或多个数据库表的过程。 换句话说，改变数据库架构的一切都是迁移。 您应该知道您可以注册多个迁移脚本，并且Vapor将按字母顺序运行它们，这就是为什么我更喜欢对它们进行语义版本控制。</p>
<p>如果使用SQL数据库，则必须创建具有预定义架构的表来存储数据。 迁移是此架构创建的过程。 您可以使用迁移脚本来更改架构，例如，如果您在模型上引入了新属性，或者使用基本条目为数据库添加了种子。 换句话说，迁移正在为模型准备数据库。 让我们看一下如何为博客模块创建迁移。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Sources/App/Modules/Blog/Migrations/BlogMigration_v1_0_0.swift */</span></span><br><span class="line"><span class="keyword">import</span> Foundation </span><br><span class="line"><span class="keyword">import</span> Fluent</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BlogMigration_v1_0_0</span>: <span class="title">Migration</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">(on database: Database)</span></span> -&gt; <span class="type">EventLoopFuture</span>&lt;<span class="type">Void</span>&gt; &#123; </span><br><span class="line">        database.eventLoop.flatten([</span><br><span class="line">            database.schema(<span class="type">BlogCategoryModel</span>.schema) </span><br><span class="line">            .id()</span><br><span class="line">            .field(<span class="type">BlogCategoryModel</span>.<span class="type">FieldKeys</span>.title, .string, .<span class="keyword">required</span>)</span><br><span class="line">            .create(), </span><br><span class="line">        database.schema(<span class="type">BlogPostModel</span>.schema)</span><br><span class="line">            .id()</span><br><span class="line">            .field(<span class="type">BlogPostModel</span>.<span class="type">FieldKeys</span>.title, .string, .<span class="keyword">required</span>) </span><br><span class="line">            .field(<span class="type">BlogPostModel</span>.<span class="type">FieldKeys</span>.slug, .string, .<span class="keyword">required</span>) </span><br><span class="line">            .field(<span class="type">BlogPostModel</span>.<span class="type">FieldKeys</span>.image, .string, .<span class="keyword">required</span>) </span><br><span class="line">            .field(<span class="type">BlogPostModel</span>.<span class="type">FieldKeys</span>.excerpt, .string, .<span class="keyword">required</span>) </span><br><span class="line">            .field(<span class="type">BlogPostModel</span>.<span class="type">FieldKeys</span>.date, .datetime, .<span class="keyword">required</span>) </span><br><span class="line">            .field(<span class="type">BlogPostModel</span>.<span class="type">FieldKeys</span>.content, .string, .<span class="keyword">required</span>)</span><br><span class="line">            .field(<span class="type">BlogPostModel</span>.<span class="type">FieldKeys</span>.categoryId, .uuid) </span><br><span class="line">            .foreignKey(<span class="type">BlogPostModel</span>.<span class="type">FieldKeys</span>.categoryId,</span><br><span class="line">                references: <span class="type">BlogCategoryModel</span>.schema, </span><br><span class="line">                .id, </span><br><span class="line">                onDelete: <span class="type">DatabaseSchema</span>.<span class="type">ForeignKeyAction</span>.setNull, </span><br><span class="line">                onUpdate: .cascade)</span><br><span class="line">            .unique(on: <span class="type">BlogPostModel</span>.<span class="type">FieldKeys</span>.slug) </span><br><span class="line">            .create(),</span><br><span class="line">        ]) </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">revert</span><span class="params">(on database: Database)</span></span> -&gt; <span class="type">EventLoopFuture</span>&lt;<span class="type">Void</span>&gt; &#123; </span><br><span class="line">        database.eventLoop.flatten([</span><br><span class="line">            database.schema(<span class="type">BlogCategoryModel</span>.schema).delete(),</span><br><span class="line">            database.schema(<span class="type">BlogPostModel</span>.schema).delete(), ])</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过模式构建器建立模型的结构。在数据库对象上，您可以通过提供名称来定义模式，然后必须列出要用作存储空间的具有给定类型的所有字段。通过使用eventLoop上的.flatten方法将它们组合在一起，可以一次创建多个方案。迁移也可以撤消，这就是为什么必须实现还原方法的原因。</p>
<p>最后，您可以使用.foreignKey方法将约束添加到字段。如果关系发生更改，约束可以更新您的数据库。您可以在删除和更新操作上设置自己的首选项。例如，如果删除父类别，则可以删除所有子类别，或将引用子类别设置为null。您还可以通过在字段上施加唯一约束来确保字段唯一。</p>
<p>在实施种子数据迁移之前，首先需要一个自定义的日期格式化程序，该程序可以将日期转换为年份字符串，反之亦然。这是因为我们仅将给定博客文章的年份存储为日期。您可以将此日期格式扩展名放在App/Extensions/DateFormatter+year.swift下。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Sources/App/Extensions/DateFormatter+Year.swift */</span></span><br><span class="line"><span class="keyword">import</span> Foundation </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">DateFormatter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> year: <span class="type">DateFormatter</span> = &#123; </span><br><span class="line">        <span class="keyword">let</span> formatter = <span class="type">DateFormatter</span>() </span><br><span class="line">        formatter.dateFormat = <span class="string">"y"</span> </span><br><span class="line">        <span class="keyword">return</span> formatter</span><br><span class="line">    &#125;() </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，我们可以将先前定义的伪数据转换为数据库种子。 我们只需要构造BlogPostModel对象，而不是先前使用的虚拟BlogPost对象。 您也可以删除该结构，因为我们不再需要它。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Sources/App/Modules/Blog/Migrations/BlogMigration_v1_0_0.swift */</span></span><br><span class="line"><span class="keyword">import</span> Foundation </span><br><span class="line"><span class="keyword">import</span> Fluent</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BlogMigration_v1_0_0</span>: <span class="title">Migration</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">uncategorizedPosts</span><span class="params">(<span class="keyword">for</span> category: BlogCategoryModel)</span></span> -&gt; [<span class="type">BlogPostModel</span>] &#123;              </span><br><span class="line">        [</span><br><span class="line">            <span class="type">BlogPostModel</span>(title: <span class="string">"California"</span>,</span><br><span class="line">                slug: <span class="string">"california"</span>,</span><br><span class="line">                image: <span class="string">"/images/posts/03.jpg"</span>,</span><br><span class="line">                excerpt: <span class="string">"Voluptates ipsa eos sit distinctio."</span>,</span><br><span class="line">                date: <span class="type">DateFormatter</span>.year.date(from: <span class="string">"2015"</span>)!,</span><br><span class="line">                content: <span class="string">"Et non reiciendis et illum corrupti. Et ducimus optio</span></span><br><span class="line"><span class="string">                    commodi molestiae quis ipsum consequatur. A fugit amet amet qui tenetur. Aut voluptates ut labore consectetur temporibus consectetur. Perferendis et neque id minima voluptatem temporibus a dolor. Eos nihil dignissimos consequuntur et consequuntur nam."</span>,</span><br><span class="line">                categoryId: category.id!),</span><br><span class="line">        ] </span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">islandPosts</span><span class="params">(<span class="keyword">for</span> category: BlogCategoryModel)</span></span> -&gt; [<span class="type">BlogPostModel</span>] &#123; [</span><br><span class="line">            <span class="type">BlogPostModel</span>(title: <span class="string">"Indonesia"</span>, slug: <span class="string">"indonesia"</span>,</span><br><span class="line">                image: <span class="string">"/images/posts/05.jpg"</span>,</span><br><span class="line">                excerpt: <span class="string">"Et excepturi id harum ipsam doloremque."</span>,</span><br><span class="line">                date: <span class="type">DateFormatter</span>.year.date(from: <span class="string">"2019"</span>)!,</span><br><span class="line">                content: <span class="string">"Accusantium amet vero numquam tenetur sit quidem ut.</span></span><br><span class="line"><span class="string">                    Officiis in iste adipisci corporis. Nisi aut consequatur laudantium et veritatis aut amet officiis. Repellat sapiente quis cupiditate veniam est. Est tempora molestiae voluptatum excepturi eum. Eos provident labore quidem ipsam."</span>,</span><br><span class="line">                categoryId: category.id!),</span><br><span class="line"></span><br><span class="line">            <span class="type">BlogPostModel</span>(title: <span class="string">"Mauritius"</span>, slug: <span class="string">"mauritius"</span>,</span><br><span class="line">                image: <span class="string">"/images/posts/04.jpg"</span>,</span><br><span class="line">                excerpt: <span class="string">"Pariatur debitis quod occaecati quidem. "</span>, </span><br><span class="line">                date: <span class="type">DateFormatter</span>.year.date(from: <span class="string">"2016"</span>)!,</span><br><span class="line">                content: <span class="string">"Enim et a ex quisquam qui sed fuga consectetur. Dolorem et eum non dicta modi tempora facilis. Totam doloremque. Libero   consequuntur et distinctio esse a provident est sunt. Rerum  quibusdam blanditiis optio dolores repudiandae magni autem consectetur. Fugit quis sed autem."</span>,</span><br><span class="line">                categoryId: category.id!),</span><br><span class="line"></span><br><span class="line">            <span class="type">BlogPostModel</span>(title: <span class="string">"The Maldives"</span>, slug: <span class="string">"the-maldives"</span>,</span><br><span class="line">                image: <span class="string">"/images/posts/02.jpg"</span>,</span><br><span class="line">                excerpt: <span class="string">"Possimus est labore recusandae asperiores fuga sequisit."</span>,</span><br><span class="line">                date: <span class="type">DateFormatter</span>.year.date(from: <span class="string">"2014"</span>)!,</span><br><span class="line">                content: <span class="string">"Dignissimos mollitia doloremque omnis repellendus quibusdam ut amet. Autem vitae enim consequuntur. Quis quo esse numquam doloremque esse.</span></span><br><span class="line"><span class="string">                Neque accusantium sint tempore distinctio. Dolorem quibusdam et ab impedit necessitatibus cum. Eius voluptatem ducimus velit non."</span>,</span><br><span class="line">                categoryId: category.id!),</span><br><span class="line">            <span class="type">BlogPostModel</span>(title: <span class="string">"Sri Lanka"</span>, slug: <span class="string">"sri-lanka"</span>,</span><br><span class="line">                image: <span class="string">"/images/posts/01.jpg"</span>,</span><br><span class="line">                excerpt: <span class="string">"Ratione est quo nemo dolor placeat dolore."</span>,</span><br><span class="line">                date: <span class="type">DateFormatter</span>.year.date(from: <span class="string">"2014"</span>)!,</span><br><span class="line">                content: <span class="string">"Deserunt nulla culpa aspernatur ea a accusantium quia</span></span><br><span class="line"><span class="string">                quibusdam. Ducimus delectus ea ipsa quisquam aut in deleniti quia. Error aliquam harum earum. Quos dignissimos dolores ratione illo. Dolores velit sunt sed quas quis itaque sit omnis. Molestias explicabo aut eum amet blanditiis quia similique soluta."</span>,</span><br><span class="line">            ] </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>您可以使用种子功能在现有类别下创建帖子。 所有这些都应该在准备使用架构之后发生。 在Flatten数组中完成块之后，我们可以使用.flatMap函数执行其他操作。 通过这种方法，可以在迁移期间将必要的数据模型创建为表行：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Sources/App/Modules/Blog/Migrations/BlogMigration_v1_0_0.swift */</span></span><br><span class="line"><span class="keyword">import</span> Foundation </span><br><span class="line"><span class="keyword">import</span> Fluent</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BlogMigration_v1_0_0</span>: <span class="title">Migration</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">(on database: Database)</span></span> -&gt; <span class="type">EventLoopFuture</span>&lt;<span class="type">Void</span>&gt; &#123; </span><br><span class="line">        database.eventLoop.flatten([</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        ]).flatMap &#123;</span><br><span class="line">            <span class="keyword">let</span> defaultCategory = <span class="type">BlogCategoryModel</span>(title: <span class="string">"Uncategorized"</span>) </span><br><span class="line">            <span class="keyword">let</span> islandsCategory = <span class="type">BlogCategoryModel</span>(title: <span class="string">"Islands"</span>) </span><br><span class="line">            <span class="keyword">return</span> [defaultCategory, islandsCategory].create(on: database) </span><br><span class="line">                    .flatMap &#123; [<span class="keyword">unowned</span> defaultCategory] <span class="keyword">in</span></span><br><span class="line">                            <span class="keyword">let</span> posts = <span class="keyword">self</span>.uncategorizedPosts(<span class="keyword">for</span>: defaultCategory) + <span class="keyword">self</span>.islandPosts(<span class="keyword">for</span>: islandsCategory)</span><br><span class="line">                        <span class="keyword">return</span> posts.create(on: database) </span><br><span class="line">                    &#125;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后一步是注册我们的迁移脚本，以便应用程序可以在需要时运行它。 为此，我们可以简单地更改configure方法，但是在继续前进之前，我们将稍作改动。</p>
<p>在上一章中，我们已将路由器注册在配置文件中。 到目前为止，每个模块都有一个路由器，似乎它们也可以进行迁移。 我们应该意识到这是一个命令模式，这就是为什么我们可以创建一个协议来表示这些东西的原因。<br>在Modules目录中创建一个名为Module.swift的新文件。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Sources/App/Modules/Module.swift */</span></span><br><span class="line"><span class="keyword">import</span> Vapor </span><br><span class="line"><span class="keyword">import</span> Fluent</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Module</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> router: <span class="type">RouteCollection?</span> &#123; <span class="keyword">get</span> &#125; </span><br><span class="line">    <span class="keyword">var</span> migrations: [<span class="type">Migration</span>] &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">configure</span><span class="params">(<span class="number">_</span> app: Application)</span></span> <span class="keyword">throws</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Module</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> router: <span class="type">RouteCollection?</span> &#123; <span class="literal">nil</span> &#125;</span><br><span class="line">    <span class="keyword">var</span> migrations: [<span class="type">Migration</span>] &#123; [] &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">configure</span><span class="params">(<span class="number">_</span> app: Application)</span></span> <span class="keyword">throws</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> migration <span class="keyword">in</span> <span class="keyword">self</span>.migrations &#123;</span><br><span class="line">            app.migrations.add(migration)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> router = <span class="keyword">self</span>.router &#123;</span><br><span class="line">            <span class="keyword">try</span> router.boot(routes: app.routes) </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模块是可以返回路由器，迁移脚本的东西。 您将看到，稍后我们将使用其他一些扩展接口。 应用程序可以使用协议上定义的配置方法遍历模块并配置所有内容。 我们可以为configure方法提供默认实现，因此模块不必这样做。</p>
<p>现在，在Frontend目录中实现一个FrontendModule对象文件。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Sources/App/Modules/Frontend/FrontendModule.swift */</span></span><br><span class="line"><span class="keyword">import</span> Vapor </span><br><span class="line"><span class="keyword">import</span> Fluent</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FrontendModule</span>: <span class="title">Module</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> router: <span class="type">RouteCollection?</span> &#123; </span><br><span class="line">        <span class="type">FrontendRouter</span>()</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下一个是Blog文件夹中的BlogModule。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Sources/App/Modules/Blog/BlogModule.swift *</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">import</span> Vapor </span><br><span class="line"><span class="keyword">import</span> Fluent</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BlogModule</span>: <span class="title">Module</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> router: <span class="type">RouteCollection?</span> &#123; </span><br><span class="line">        <span class="type">BlogRouter</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> migrations: [<span class="type">Migration</span>] &#123; </span><br><span class="line">        [<span class="type">BlogMigration_v1_0_0</span>(), ]</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，我们将稍稍更改配置文件，可以随时删除原始路由注册，因为从现在开始，该模块将处理所有事情。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Sources/App/configure.swift */</span></span><br><span class="line"><span class="keyword">import</span> Leaf</span><br><span class="line"><span class="keyword">import</span> Fluent</span><br><span class="line"><span class="keyword">import</span> FluentSQLiteDriver </span><br><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">configure</span><span class="params">(<span class="number">_</span> app: Application)</span></span> <span class="keyword">throws</span> &#123; </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">let</span> modules: [<span class="type">Module</span>] = [ <span class="type">FrontendModule</span>(), <span class="type">BlogModule</span>(), ]</span><br><span class="line">    <span class="keyword">for</span> module <span class="keyword">in</span> modules &#123;</span><br><span class="line">        <span class="keyword">try</span> module.configure(app)</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们准备迁移数据库。</p>
<p>您应该知道，如果您运行该应用程序，则默认情况下它将执行一个称为serve的命令，但是您不必显式提供serve参数。 此命令负责启动基础HTTP服务器，当您运行应用程序时，serve命令将使用给定的主机名和端口开始侦听。 这是Vapor中的默认命令。</p>
<p>为了运行迁移，您已经使用migration参数启动了应用程序，这将运行迁移脚本而不是启动Web服务器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift run Run migrate</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.xuebaonline.com/vapor-4-stp2.png" alt="&quot;&quot;"></p>
<p>或者，您可以在Xcode的“编辑方案”菜单下设置命令行参数：</p>
<p><img src="https://cdn.xuebaonline.com/vapor-4-stp1.png" alt="&quot;&quot;"></p>
<p>如果使用此迁移参数运行该应用程序，则会看到提示，您必须确认迁移。您可以通过在运行应用程序时提供–auto-migrate标志作为额外的参数来跳过确认。</p>
<p>如果您使用的是Xcode，则可以简单地复制方案并为每个方案设置不同的参数。这样，您只需选择例如迁移方案，而不是运行/myProject方案。</p>
<p>在第一次迁移期间，Fluent将创建一个名为_fluent_migrations的内部表。迁移系统正在使用该查找表来检测哪些迁移已经执行，以及下次运行migration命令时需要完成哪些迁移。</p>
<p>迁移脚本正在分批执行。当您运行迁移命令时，这是一个批处理。每个需要运行的迁移脚本都将具有相同的批次标识符。下次运行迁移命令时，Vapor将检查查找表，它确定需要执行的操作，增加批次标识符，运行新的迁移并将其保存在表中。</p>
<p>您可以通过运行带有–revert标志的migration命令来还原最后一批迁移。 这将仅还原最后一批迁移，因此您可能必须运行多次才能还原所有内容。 或者，您可以从磁盘上删除整个SQLite数据库文件，这将重置所有内容。</p>
<p>数据库文件将在工作目录下创建。 浏览SQLite文件非常容易，您可以下载并使用<a href="https://sqlitebrowser.org" target="_blank" rel="noopener">https://sqlitebrowser.org</a> 应用程序，也可以通过brew cask install db-browser-for-sqlite命令安装它。</p>
<h1 id="查询和渲染"><a href="#查询和渲染" class="headerlink" title="查询和渲染"></a>查询和渲染</h1><p>现在，我们可以使用种子数据进行工作迁移了，我们可以开始使用Fluent检索模型了。 另一件事是，我不喜欢使用直接来自Fluent层的模型来渲染视图，但我更喜欢有一个ViewContext对象，可以安全地将其作为Leaf的上下文项传递。 这是因为模型可以包含敏感信息，只考虑带有密码哈希的用户，最好定义一个可编码的视图上下文并将数据库模型映射到其中。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Sources/App/Modules/Blog/Models/BlogCategoryModel.swift */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">BlogCategoryModel</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ViewContext</span>: <span class="title">Encodable</span> </span>&#123; </span><br><span class="line">        <span class="keyword">var</span> id: <span class="type">String</span></span><br><span class="line">        <span class="keyword">var</span> title: <span class="type">String</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">init</span>(model: <span class="type">BlogCategoryModel</span>) &#123; </span><br><span class="line">            <span class="keyword">self</span>.id = model.id!.uuidString </span><br><span class="line">            <span class="keyword">self</span>.title = model.title</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> viewContext: <span class="type">ViewContext</span> &#123; </span><br><span class="line">        .<span class="keyword">init</span>(model: <span class="keyword">self</span>) </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ViewContext结构是一个Encodable对象，具有基于模型的属性。 您可以将该扩展名放在模型旁边，在这种情况下，不需要新文件。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Sources/App/Modules/Blog/Models/BlogPostModel.swift */</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">BlogPostModel</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ViewContext</span>: <span class="title">Encodable</span> </span>&#123; </span><br><span class="line">        <span class="keyword">var</span> id: <span class="type">String</span></span><br><span class="line">        <span class="keyword">var</span> title: <span class="type">String</span> </span><br><span class="line">        <span class="keyword">var</span> slug: <span class="type">String</span> </span><br><span class="line">        <span class="keyword">var</span> image: <span class="type">String</span> </span><br><span class="line">        <span class="keyword">var</span> excerpt: <span class="type">String</span> </span><br><span class="line">        <span class="keyword">var</span> date: <span class="type">String</span> </span><br><span class="line">        <span class="keyword">var</span> content: <span class="type">String</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">init</span>(model: <span class="type">BlogPostModel</span>) &#123; </span><br><span class="line">            <span class="keyword">self</span>.id = model.id!.uuidString </span><br><span class="line">            <span class="keyword">self</span>.title = model.title </span><br><span class="line">            <span class="keyword">self</span>.slug = model.slug </span><br><span class="line">            <span class="keyword">self</span>.image = model.image s</span><br><span class="line">            elf.excerpt = model.excerpt</span><br><span class="line">            <span class="keyword">self</span>.date = <span class="type">DateFormatter</span>.year.string(from: model.date)</span><br><span class="line">            <span class="keyword">self</span>.content = model.content</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">var</span> viewContext: <span class="type">ViewContext</span> &#123; </span><br><span class="line">        .<span class="keyword">init</span>(model: <span class="keyword">self</span>) </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一项很无聊且重复的任务，但是请相信我，长期的努力是值得的。 我总是从视图上下文对象中忽略关系，因为在某些情况下会引起问题。 我有一个更好的方法来处理该问题，我将在短短几秒钟内向您展示。 在BlogFrontendController中，我们必须进行一些更改：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Sources/App/Modules/Blog/BlogFrontendController.swift */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BlogFrontendController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">blogView</span><span class="params">(req: Request)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">EventLoopFuture</span>&lt;<span class="type">View</span>&gt; &#123; </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Context</span>: <span class="title">Encodable</span> </span>&#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">PostWithCategory</span>: <span class="title">Encodable</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> category: <span class="type">BlogCategoryModel</span>.<span class="type">ViewContext</span> </span><br><span class="line">                    <span class="keyword">var</span> post: <span class="type">BlogPostModel</span>.<span class="type">ViewContext</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> title: <span class="type">String</span></span><br><span class="line">            <span class="keyword">let</span> items: [<span class="type">PostWithCategory</span>]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="type">BlogPostModel</span>.query(on: req.db) </span><br><span class="line">                .<span class="built_in">sort</span>(\.$date, .descending) </span><br><span class="line">                .with(\.$category)</span><br><span class="line">                .all()</span><br><span class="line">                .mapEach &#123; </span><br><span class="line">                    <span class="type">Context</span>.<span class="type">PostWithCategory</span>(category: $<span class="number">0</span>.category.viewContext, post: $<span class="number">0</span>.viewContext) &#125;</span><br><span class="line">                .flatMap &#123; </span><br><span class="line">                    <span class="keyword">let</span> context = <span class="type">Context</span>(title: <span class="string">"myPage - Blog"</span>, items: $<span class="number">0</span>) </span><br><span class="line">                    <span class="keyword">return</span> req.view.render(<span class="string">"blog"</span>, context) &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>您应该注意的第一件事是我们正在创建一个新的PostWithCategory结构。这是博客文章和相关类别对象的容器。我们可以将这些项目存储在Context对象中。</p>
<p>接下来，我们可以在Model上使用静态查询方法，以从数据库表中请求实体。这将返回一个查询构建器实例，您可以通过添加各种过滤器，限制和排序选项来进行调整。使用with方法，可以将关系对象加载到模型中。 all方法将执行查询，并将请求的行作为Model对象返回。稍后我们将看到更多数据库查询示例。</p>
<p>我们可以使用mapEach函数将每个项目转换为新的项目。在我们的例子中，我们需要上下文项来呈现视图。这整个链返回一个EventLoopF​​uture，因此我们可以使用flatMap方法使用该块中的项目来呈现视图。</p>
<p>现在，我们只需要稍微更改一下相应的博客视图，因为items数组现在是PostWithCategory对象，因此我们可以使用点语法访问post＆category。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Resources/Views/blog.leaf */</span></span><br><span class="line">#extend(<span class="string">"index"</span>): </span><br><span class="line">    #export(<span class="string">"body"</span>):</span><br><span class="line">    &lt;section id=<span class="string">"blog"</span> <span class="class"><span class="keyword">class</span>="<span class="title">wrapper</span>"&gt; </span></span><br><span class="line"><span class="class">        &lt;<span class="title">h2</span>&gt;<span class="title">Blog</span>&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line"><span class="class">        #<span class="title">for</span>(<span class="title">item</span> <span class="title">in</span> <span class="title">items</span>):</span></span><br><span class="line"><span class="class">            &lt;<span class="title">article</span>&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">a</span> <span class="title">href</span>="/#(<span class="title">item</span>.<span class="title">post</span>.<span class="title">slug</span>)"&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">img</span> <span class="title">src</span>="#(<span class="title">item</span>.<span class="title">post</span>.<span class="title">image</span>)"&gt; </span></span><br><span class="line"><span class="class">                &lt;<span class="title">h3</span>&gt;#(<span class="title">item</span>.<span class="title">post</span>.<span class="title">title</span>) (#(<span class="title">item</span>.<span class="title">post</span>.<span class="title">date</span>))&lt;/<span class="title">h3</span>&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">p</span>&gt;#(<span class="title">item</span>.<span class="title">post</span>.<span class="title">excerpt</span>)&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">p</span> <span class="title">class</span>="<span class="title">category</span>"&gt;#(<span class="title">item</span>.<span class="title">category</span>.<span class="title">title</span>)&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="class">                &lt;/<span class="title">a</span>&gt; </span></span><br><span class="line"><span class="class">            &lt;/<span class="title">article</span>&gt;</span></span><br><span class="line"><span class="class">        #<span class="title">endfor</span></span></span><br><span class="line"><span class="class">    &lt;/<span class="title">section</span>&gt;</span></span><br><span class="line"><span class="class">    #<span class="title">endexport</span> </span></span><br><span class="line"><span class="class">#<span class="title">endextend</span></span></span><br></pre></td></tr></table></figure>

<p>接下来，对细节页面执行几乎完全相同的操作。 确保这次导入Fluent框架，否则编译器将告诉您.filter()行是错误的，因为表达式的类型是模棱两可的，没有更多上下文。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Sources/App/Modules/Blog/BlogFrontendController.swift */</span></span><br><span class="line"><span class="keyword">import</span> Fluent</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BlogFrontendController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">postView</span><span class="params">(req: Request)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">EventLoopFuture</span>&lt;<span class="type">Response</span>&gt; &#123; </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Context</span>: <span class="title">Encodable</span> </span>&#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">PostWithCategory</span>: <span class="title">Encodable</span> </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> category: <span class="type">BlogCategoryModel</span>.<span class="type">ViewContext</span> </span><br><span class="line">                <span class="keyword">var</span> post: <span class="type">BlogPostModel</span>.<span class="type">ViewContext</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> title: <span class="type">String</span></span><br><span class="line">            <span class="keyword">let</span> item: <span class="type">PostWithCategory</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> slug = req.url.path.trimmingCharacters(<span class="keyword">in</span>: .<span class="keyword">init</span>(charactersIn: <span class="string">"/"</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="type">BlogPostModel</span>.query(on: req.db) </span><br><span class="line">                .<span class="built_in">filter</span>(\.$slug == slug) </span><br><span class="line">                .with(\.$category)</span><br><span class="line">                .first()</span><br><span class="line">                .flatMap &#123; post <span class="keyword">in</span></span><br><span class="line">                    <span class="keyword">guard</span> <span class="keyword">let</span> post = post <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> req.eventLoop.future(req.redirect(to: <span class="string">"/"</span>)) </span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">let</span> item = <span class="type">Context</span>.<span class="type">PostWithCategory</span>(category: post.category.viewContext, post: post.viewContext)</span><br><span class="line">                    <span class="keyword">let</span> context = <span class="type">Context</span>(title: <span class="string">"myPage - \("</span>post.title<span class="string">")"</span>, item: item)</span><br><span class="line">                    <span class="keyword">return</span> req.view.render(<span class="string">"post"</span>, context).encodeResponse(<span class="keyword">for</span>: req) &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PostWithCategory结构是多余的，我们可以简单地将其从上下文中移出，这样就不会重复任何代码。无论如何，我们使用与以前相同的方法来请求博客文章模型，但是这次我们通过搜索一个条目来过滤列表。</p>
<p>与Fluent查询构建器相关的几乎所有内容都使用Swift键路径。键路径是一种特殊类型，可以通过在属性名称前使用\字符来构造它。在这种情况下，我们始终使用\。$ <field>表达式来引用fields属性包装器的键路径。乍一看这有点奇怪，但是您可以习惯它。</p>
<p>使用$前缀，您可以访问属性包装器本身，而无需$符号，则可以引用属性的keyPath。当我们使用Fluent过滤某些内容时，我们通常希望到达属性包装器，因此框架可以使用存储在包装器上的字段名称和包装的值来基于它们创建查询字符串。</p>
<p>在过滤博客文章列表之后，我们加载类别对象并请求结果的第一个元素。如果没有这样的元素，我们只需重定向到主屏幕。否则，我们可以将博客文章转换为视图上下文，并在模板中使用它。</p>
<p>顺便说一下，我们也必须更改post.leaf文件：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* FILE:</span></span><br><span class="line"><span class="comment">* Resources/Views/post.leaf */</span></span><br><span class="line"><span class="selector-id">#extend</span>("<span class="selector-tag">index</span>"): </span><br><span class="line">    <span class="selector-id">#export</span>("<span class="selector-tag">body</span>"):</span><br><span class="line">    &lt;section id="blog" class="wrapper"&gt;</span><br><span class="line">        &lt;img src="#(item.post.image)"&gt; </span><br><span class="line">        &lt;h2&gt;#(item.post.title) (#(item.post.date))&lt;/h2&gt; </span><br><span class="line">        &lt;p&gt;#(item.post.excerpt)&lt;/p&gt;</span><br><span class="line">        &lt;p class="category"&gt;#(item.post.category)&lt;/p&gt; </span><br><span class="line">        &lt;p&gt;#(item.post.content)&lt;/p&gt;</span><br><span class="line">    &lt;/section&gt;</span><br><span class="line">    <span class="selector-id">#endexport</span> </span><br><span class="line"><span class="selector-id">#endextend</span></span><br></pre></td></tr></table></figure>

<p>现在，我们可以安全地删除旧的BlogPost.swift和BlogRepository.swift文件。 再次运行该应用程序，但是如果您使用的是Xcode，请不要忘记禁用migration参数。 您应该看到博客现在正在使用真实的SQLite数据库运行。</p>
<h1 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h1><p>在本章中，我们探讨了Fluent的工作方式，已成功地将博客存储迁移到了正常的SQLite数据库中。 我们已经了解了模式构建器以及它们如何帮助我们为模型创建类型安全的SQL数据库表。 我们还学习了很多有关通过属性包装器使用各种字段类型和关系对数据库实体建模的知识。 除了当前的模块化结构之外，我们还引入了Module协议，并且了解了为什么使用分离的视图模型来呈现Fluent实体是一件好事。</p>

    </div>

    
    
    
        <div class="reward-container">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="Char 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="Char 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>
  <div class="addthis_inline_share_toolbox">
    <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5eacc50f0dcd8169" async="async"></script>
  </div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Char
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://www.xuebaonline.com/Vapor%E7%B3%BB%E5%88%97%20(%E5%9B%9B)%20:%20%20%E5%88%9B%E5%BB%BA%E5%8D%9A%E5%AE%A2%E6%95%B0%E6%8D%AE%E5%BA%93/" title="Vapor系列 (四) :  创建博客数据库">https://www.xuebaonline.com/Vapor系列 (四) :  创建博客数据库/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="https://twitter.com/Bogon">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="/images/connectme.JPG">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Swift-5-0/" rel="tag"><i class="fa fa-tag"></i> Swift 5.0</a>
              <a href="/tags/Vapor-4-0/" rel="tag"><i class="fa fa-tag"></i> Vapor 4.0</a>
              <a href="/tags/%E5%88%9B%E5%BB%BA%E5%8D%9A%E5%AE%A2%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"><i class="fa fa-tag"></i> 创建博客数据库</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/Vapor%E7%B3%BB%E5%88%97%20(%E4%B8%89)%20:%20%E4%BD%BF%E7%94%A8Leaf%E6%9E%84%E5%BB%BA%E7%BD%91%E7%AB%99/" rel="prev" title="Vapor系列 (三) : 使用Leaf构建网站">
      <i class="fa fa-chevron-left"></i> Vapor系列 (三) : 使用Leaf构建网站
    </a></div>
      <div class="post-nav-item">
    <a href="/Vapor%E7%B3%BB%E5%88%97%20(%E4%BA%94)%20:%20%20%E4%BD%BF%E7%94%A8session%E8%BF%9B%E8%A1%8Cauthentication/" rel="next" title="Vapor系列 (五) :  使用session进行authentication">
      Vapor系列 (五) :  使用session进行authentication <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#从Fluent入手"><span class="nav-number">1.</span> <span class="nav-text">从Fluent入手</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用模型"><span class="nav-number">2.</span> <span class="nav-text">使用模型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据库迁移"><span class="nav-number">3.</span> <span class="nav-text">数据库迁移</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#查询和渲染"><span class="nav-number">4.</span> <span class="nav-text">查询和渲染</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#摘要"><span class="nav-number">5.</span> <span class="nav-text">摘要</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Char"
      src="https://cdn.xuebaonline.com/blog_avatar.JPG">
  <p class="site-author-name" itemprop="name">Char</p>
  <div class="site-description" itemprop="description">曾经沧海难为水，除却巫山不是云。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">151</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">124</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element">
    <a onclick="Chatra('openChat', true);"><i class="fa fa-comment"></i>
    联系我
  </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Bogon" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Bogon" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhangqixcu@gmail.com" title="E-Mail → mailto:zhangqixcu@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/5640441479" title="新浪微博 → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;5640441479" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/bogonbug" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;bogonbug" rel="noopener" target="_blank"><i class="fab fa-skype fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/Bogon" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;Bogon" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/4368897/qizhang" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;4368897&#x2F;qizhang" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i></a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      推荐阅读
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://developer.apple.com/swift/" title="https:&#x2F;&#x2F;developer.apple.com&#x2F;swift&#x2F;" rel="noopener" target="_blank">Swift 5.3</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://developer.apple.com/documentation/objectivec" title="https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;objectivec" rel="noopener" target="_blank">Objective-C</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">豫ICP备20011156号-1 </a>
      <img src="/images/beian.png" style="display: inline-block;"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41172402000135" rel="noopener" target="_blank">豫公网安备41172402000135号 </a>
  </div>

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Char</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">博客全站共1.3m字</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">20:02</span>
</div>

<!--
  <div class="addthis_inline_share_toolbox">
    <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5eacc50f0dcd8169" async="async"></script>
  </div>
-->

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  
<script src="/js/local-search.js"></script>




  <script>
    (function(d, w, c) {
      w.ChatraID = 'PxGFNHLgjQ3C3Hmpo';
      var s = d.createElement('script');
      w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
      };
      s.async = true;
      s.src = 'https://call.chatra.io/chatra.js';
      if (d.head) d.head.appendChild(s);
    })(document, window, 'Chatra');
  </script>









  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'rfRdmQpsk2Crnz747tDDOu26-gzGzoHsz',
      appKey     : 'eyu1k9BeINgR5FuXzbc969UA',
      placeholder: "写出你的想法……",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

<script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>